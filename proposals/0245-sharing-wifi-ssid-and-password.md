# WiFi: Sharing SSID and password with Mobile Proxy

* Proposal: [SDL-0245](0245-sharing-wifi-ssid-and-password.md)
* Author: [Alexander Kutsan](https://github.com/LuxoftAKutasan)
* Status: **In Review**
* Impacted Platforms: [Java Suite / iOS / RPC / Core / HMI]

## Introduction

The current proposal defines rules and communication facilities between IVI and the Mobile device to establish a WiFi connection with the automatic sharing of credentials via Core.

## Motivation

In the current implementation of SDL over WiFi transport, IP address and port are shared with Mobile proxy. However, the prerequisite for using SDL over WiFi transport is that the mobile device should be connected to WiFi. In some cases, entering a password for the access point created by HMI could be tedious and it would be a lot more convenient for users if devices could automatically connect via WiFi.

If WiFi credentials are automatically generated by the IVI system, the password could contain special characters or it could be just too long. It would be inconvenient for the user to enter such passwords in the HMI. Another possible scenario is, the HMI could keep changing passwords to improve the security of the network. In such cases, a user might need to connect to the WiFi network every time the password is changed.

## Proposed solution

Current proposal introduces additional APIs for sharing Wifi credentials between the vehicle and devices.

This solution does not put on SDL any logic to determine access point host.
This decision should be controlled by HMI.

SDL does not have direct access to Wifi hardware, so SDL is not able to check the current Wifi state.
Such an approach gives OEM the ability to have own rules and priorities for Wifi interaction.

This approach can be easily integrated into some already existing solution because there is no additional logic on SDL, and OEM may just adopt an existing solution for using new APIs.

The proposed approach designed to avoid bidirectional RPC because it adds technical complexity that causes additional bugs.

Following API extension will provide mobile device ability to share their networking capabilities.

### Sharing mobile networking capabilities with the vehicle

**MOBILE_API** :

SDL should receive Mobile capabilities within `DeviceInfo` section of `RegisterAppInterface` request.

```xml
<enum name="FrequencyBand" since="x.x">
    <element name="FREQUENCY_BAND_2_4_GHZ"/>
    <element name="FREQUENCY_BAND_5_0_GHZ"/>
    <element name="FREQUENCY_BAND_6_0_GHZ"/>
</enum>

<enum name="NetworkHost" since="x.x">
    <element name="MOBILE"/>
      <description>
        Use Mobile device as Wifi access point
      </description>
    </element>
    <element name="VEHICLE"/>
      <description>
        Use Vehicle as Wifi access point
      </description>
    </element>
</enum>

<struct name="MobileNetworkingCapabilities" since="x.x">
  <description>
    Describes sending device's availability configurations around WiFi networking.
    This includes the ability to automatically join a network or to host one by itself.
  </description>
    <param name="autoJoinWiFiSupported" type="Boolean" mandatory="false">
      <description>
        Defines whether Mobile application supports programmatic join to the external network
      </description>
    </param>
    <param name="hostingWiFiSupported" type="Boolean" mandatory="false">
      <description>Defines whether Mobile device is capable of hosting WiFi network.</description>
    </param>
    <param name="preferredNetworkHost" type="NetworkHost" mandatory="false">
      <description>
        This describes the preference of what device (vehicle or mobile) to use as a WiFi access point.
      </description>
    </param>
    <param name="wifiFrequencyBandsSupported" type="FrequencyBand" array="true" minSize="1" maxSize="100" mandatory="false">
      <description>
        An array of frequencies supported by the device.
      </description>
    </param>
</struct>

<struct name="DeviceInfo" since="3.0">
    ...
    <param name="networkingCapabilities" type="MobileNetworkingCapabilities" mandatory="false" since="x.x">
        <description>Device's available configurations around networking</description>
    </param>
    ...
</struct>
```

**HMI_API** :

SDL will send mobile networking capabilities in OnAppRegistered notification within `DeviceInfo` struct

```xml

<enum name="NetworkHost">
    <element name="MOBILE"/>
      <description>
        Use Mobile device as Wifi access point
      </description>
    </element>
    <element name="VEHICLE"/>
      <description>
        Use Vehicle as Wifi access point
      </description>
    </element>
</enum>

<enum name="FrequencyBand">
    <element name="FREQUENCY_BAND_2_4_GHZ"/>
    <element name="FREQUENCY_BAND_5_0_GHZ"/>
    <element name="FREQUENCY_BAND_6_0_GHZ"/>
</enum>

<struct name="MobileNetworkingCapabilities">

  <description>
    Describes sending device's availability configurations around WiFi networking.
    This includes the ability to automatically join a network or to host one by itself.
  </description>

  <param name="autoJoinWiFiSupported" type="Boolean" mandatory="false">
    <description>
      Defines whether Mobile application supports programmatic join to the external network
    </description>
  </param>
  <param name="hostingWiFiSupported" type="Boolean" mandatory="false">
    <description>
      Defines whether Mobile device is capable of hosting WiFi network.
    </description>
  </param>
    <param name="preferredNetworkHost" type="NetworkHost" mandatory="false">
      <description>
        This describes the preference of what device (vehicle or mobile) to use as a WiFi access point.
    </description>
    </param>
    <param name="wifiFrequencyBandsSupported" type="FrequencyBand" array="true" minsize="1" maxsize="100" mandatory="false">
      <description>
        An array of frequencies supported by the device.
      </description>
    </param>
</struct>

<struct name="DeviceInfo">
  ...
  <param name="networkingCapabilities" type="MobileNetworkingCapabilities" mandatory="false">
        <description>Describes Device networking capabilities</description>
  </param>
  ...
</struct>

```

### INI file update

Ini file will contain supported modes for the vehicle.
SDL should restrict RPCs not supported by the vehicle.

```ini
[Networking]

; WifiModesSupported provides information to SDL if HMI can join to an external wifi network, and if it can host Wifi network. 
; SDL should not allow JoinMobileNetwork requests from mobile if HMI is not able to join a network, 
; SDL should not allow JoinVehicleNetwork requests from HMI if HMI is not able to host network.
WifiModesSupported = AccessPoint, WifiClient

```


If `WifiModesSupported` is empty or ommited SDL will not process `JoinVehicleNetwork` and `JoinMobileNetwork` RPCs and respond with error, `UNSUPPORTED_REQUEST` result code.

### Sharing SSID with Join request

Against sharing SSID with a password via `Get` requests, proposed to use *HollywoodPrinciple* : "Don't call us, we'll call you".

If Vehicle is ready to accept Wifi connection, it will ask Mobile for connection via `JoinVehicleNetwork`

If the Vehicle is ready to connect to the mobile access point it will notify the Mobile via `ReadyForWifiConnection`.

If Mobile is ready to accept Wifi connection, it will ask Vehicle for connection via `JoinMobileNetwork`

Following API changes required :
#### MOBILE_API

```xml

<enum name="WiFiSecurityType">
    <description>enum to define WiFi security types used for WiFi connection.</description>
    <element name="NONE"/>
    <element name="WEP"/>
    <element name="WPA"/>
    <element name="WPA2"/>
    <element name="WPA3"/>
</enum>


<function name="ReadyForWifiConnection" functionID="ReadyForWifiConnectionID" messagetype="notification" since="x.x">
    <description>
      Notification from Vehicle to Mobile to inform that Vehicle is ready to be Wifi client and requests Wifi connection with mobile as an access point. 
    </description>

    <param name="wifiFrequencyBandsSupported" type="FrequencyBand" array="true" minsize="1" maxsize="100" mandatory="false">
      <description>
        An array of frequencies supported by the vehicle.
      </description>
    </param>
</function>

<function name="JoinVehicleNetwork" functionID="JoinVehicleNetworkID" messagetype="request" since="x.x">
    <description>
      A request to the mobile to join the Vehicle network.
    </description>

    <param name="ssid" type="String" minlength="1" maxlength="32" mandatory="true">
        <description>vehicle access point SSID</description>
    </param>
    <param name="password" type="String" minlength="1" maxlength="100" mandatory="false">
        <description>password to use to connect AP</description>
    </param>
    <param name="securityType" type="WiFiSecurityType" mandatory="false">
        <description>security type of WiFi AP</description>
    </param>
    <param name="accesssPointSupportsInternetAccess" type="Boolean" mandatory="false">
        <description>true if access point provides internet access, otherwise false.</description>
    </param>
</function>

<function name="JoinVehicleNetwork" functionID="JoinVehicleNetworkID" messagetype="response" since="6.2">
    <description>A response and description of requested action.</description>
    <param name="success" type="Boolean" platform="documentation" mandatory="true">
        <description> true, if successful; false, if failed </description>
    </param>
    <param name="resultCode" type="Result" platform="documentation" mandatory="true">
        <description>See Result</description>
        <element name="SUCCESS"/>
        <element name="UNSUPPORTED_RESOURCE"/>
        <element name="DISALLOWED"/>
        <element name="REJECTED"/>
        <element name="TOO_MANY_PENDING_REQUESTS"/>
        <element name="APPLICATION_NOT_REGISTERED"/>
        <element name="GENERIC_ERROR"/>
        <element name="USER_DISALLOWED"/>
    </param>
    <param name="info" type="String" maxlength="1000" mandatory="false" platform="documentation">
        <description>Provides additional human readable info regarding the result.</description>
    </param>
</function>

<function name="JoinMobileNetwork" functionID="JoinMobileNetworkID" messagetype="request" since="x.x">
    <description>
      A request to the vehicle to join the mobile network.
    </description>
        
    <param name="ssid" type="String" minlength="1" maxlength="32" mandatory="true">
        <description>mobile access point SSID</description>
    </param>
    <param name="password" type="String" minlength="1" maxlength="100" mandatory="false">
        <description>password to use to connect AP</description>
    </param>
    <param name="securityType" type="WiFiSecurityType" mandatory="false">
        <description>security type of WiFi AP</description>
    </param>
    <param name="allowAccessPointSharing" type="Boolean" mandatory="false">
        <description>true if it is acceptable to share this network's SSID and password with other nearby devices. This is helpful if two mobile devices connected to a head unit, and one of them is selected as the network host.</description>
    </param>
    <param name="accesssPointSupportsInternetAccess" type="Boolean" mandatory="false">
        <description>true if access point provides internet access, otherwise false.</description>
    </param>
</function>

<function name="JoinMobileNetwork" functionID="JoinMobileNetworkID" messagetype="response" since="6.2">
    <description>A response and description of requested action.</description>
    <param name="success" type="Boolean" platform="documentation" mandatory="true">
        <description> true, if successful; false, if failed </description>
    </param>
    <param name="resultCode" type="Result" platform="documentation" mandatory="true">
        <description>See Result</description>
        <element name="SUCCESS"/>
        <element name="UNSUPPORTED_RESOURCE"/>
        <element name="DISALLOWED"/>
        <element name="REJECTED"/>
        <element name="TOO_MANY_PENDING_REQUESTS"/>
        <element name="APPLICATION_NOT_REGISTERED"/>
        <element name="GENERIC_ERROR"/>
        <element name="USER_DISALLOWED"/>
    </param>
    <param name="info" type="String" maxlength="1000" mandatory="false" platform="documentation">
        <description>Provides additional human readable info regarding the result.</description>
    </param>
</function>


```

#### HMI API

```xml
<enum name="WiFiSecurityType">
    <description>enum to define WiFi security types used for WiFi connection.</description>
    <element name="NONE"/>
    <element name="WEP"/>
    <element name="WPA"/>
    <element name="WPA2"/>
    <element name="WPA3"/>
</enum>

<function name="ReadyForWifiConnection" messagetype="notification">
    <description>
      Notification from Vehicle to Mobile to inform that Vehicle is ready to be Wifi client and requests Wifi connection with the mobile device as an access point. 
    </description>


    <param name="appID" type="Integer" mandatory="true">
      <description>Unique (during ignition cycle) id of the application.</description>
    </param>

    <param name="wifiFrequencyBandsSupported" type="FrequencyBand" array="true" minsize="1" maxsize="100" mandatory="false">
      <description>
        An array of frequencies supported by the vehicle.
      </description>
    </param>
</function>

<function name="JoinVehicleNetwork" messagetype="request">
    <description>
      request to the Mobile to join the Vehicle network.
    </description>

    <param name="appID" type="Integer" mandatory="true">
      <description>Unique (during ignition cycle) id of the application. </description>
    </param>

    <param name="ssid" type="String" minlength="1" maxlength="32" mandatory="true">
        <description>vehicle access point SSID</description>
    </param>
    <param name="password" type="String" minlength="1" maxlength="100" mandatory="false">
        <description>password to use to connect AP</description>
    </param>
    <param name="securityType" type="Common.WiFiSecurityType" mandatory="false">
        <description>security type of WiFi AP</description>
    </param>
    <param name="accesssPointSupportsInternetAccess" type="Boolean" mandatory="false">
        <description>True if access point provides internet access, otherwise false.</description>
    </param>
</function>

<function name="JoinVehicleNetwork" messagetype="response">
    <description>A response and description of requested action.</description>
    <param name="success" type="Boolean" platform="documentation" mandatory="true">
        <description> true, if successful; false, if failed </description>
    </param>
    <param name="resultCode" type="Common.Result" platform="documentation" mandatory="true">
    </param>
    <param name="info" type="String" maxlength="1000" mandatory="false" platform="documentation">
        <description>Provides additional human readable info regarding the result.</description>
    </param>
</function>

<function name="JoinMobileNetwork" messagetype="request">
    <description>
      A request to the vehicle to join the mobile network.
    </description>

    <param name="appID" type="Integer" mandatory="true">
      <description>Unique (during ignition cycle) id of the application.</description>
    </param>

    <param name="ssid" type="String" minlength="1" maxlength="32" mandatory="true">
        <description>mobile access point SSID</description>
    </param>
    <param name="password" type="String" minlength="1" maxlength="100" mandatory="false">
        <description>password to use to connect AP</description>
    </param>
    <param name="securityType" type="Common.WiFiSecurityType" mandatory="false">
        <description>security type of WiFi AP</description>
    </param>
    <param name="allowAccessPointSharing" type="Boolean" mandatory="false">
        <description>true if it is acceptable to share this network's SSID and password with other nearby devices. This is helpful if two mobile devices connected to a head unit, and one of them is selected as the network host.</description>
    </param>
    <param name="accesssPointSupportsInternetAccess" type="Boolean" mandatory="false">
        <description>true if access point provides internet access, otherwise false.</description>
    </param>
</function>

<function name="JoinMobileNetwork" messagetype="response">
    <description>A response and description of requested action.</description>
    <param name="success" type="Boolean" platform="documentation" mandatory="true">
        <description> true, if successful; false, if failed </description>
    </param>
    <param name="resultCode" type="Common.Result" platform="documentation" mandatory="true">
    </param>
    <param name="info" type="String" maxlength="1000" mandatory="false" platform="documentation">
        <description>Provides additional human readable info regarding the result.</description>
    </param>
</function>
```

HMI should send `JoinVehicleNetwork` to Mobile if wifi connection required. 
OEM can decide if this requires should be sent either on app activation of after app registration. 

HMI should send `ReadyForWifiConnection` to mobile if the WiFi connection is required but OEM prefers to use mobile device's Wifi. 

Mobile should send `JoinMobileNetwork` to Vehicle right after receiving `ReadyForWifiConnection`

SDL will not filter `JoinMobileNetwork` if HMI didn't send `ReadyForWifiConnection` before. 

__Note:__ `JoinVehicleNetwork`, `JoinMobileNetwork` should not depend on the default RPC timeout, since WiFi connection may take much more time. So, this RPC has to operate without an active timeout from the sdl_core perspective.

![Sharing SSID minimal approach](../assets/proposals/0245-sharing-wifi-ssid-and-password/minimal_approach.png)

#### Manual Wifi connection

HMI should not send `JoinVehicleNetwork` to the application if at least one application on the corresponding device started Wifi secondary transport. HMI will take information about device apps and transports from UpdateAppList and UpdateDeviceList notifications from SDL. 

If the user established Wifi connection manually, the Vehicle has no instruments to check that it is connected to the same Wifi network as mobile application until application won't start secondary transport. 

So HMI may send redundant `JoinVehicleNetwork`/`ReadyForWifiConnection` to the application. `sdl_proxy` should not initiate the connection to Vehicle Wifi network if it is already connected. 

### Multiple device connections

OEM have full control on multiple device connection policy. 

### RPCs Encryption

Wifi credentials are considered sensitive data, and should not be shared without encryption.

To protect Wifi credentials [SDL 0207 - RPC message protection](https://github.com/smartdevicelink/sdl_evolution/issues/634) SDL feature is used.

RPC message protection is controlled completely by the Policy table.

It is advised to restrict `JoinMobileNetwork`, `JoinVehicleNetwork`, to be sent only by encrypted RPC service, but it is up to particular OEM. SDL does not enforce these RPCs, to be sent only by encrypted RPC service.

SDL will not transfer `JoinVehicleNetwork` to mobile by nonsecure RPC service if encryption required. SDL will respond with the `REJECTED` result code.

HMI should know about RPC service encryption status for each application. 
therefore proposed to extend `OnServiceUpdate` notification with the appropriate information : 
```xml

<function name="OnServiceUpdate" messagetype="notification">
  <param name="encrypted" type="true" mandatory="false">
</function>

```
If `encrypted` parameter is omitted, it means that service is not encrypted.

### Preloaded policy table

It is proposed to introduce a new functional group within the current proposal:

```json
"policy_table": {
    ...
    "functional_groupings": {
        ...
        "NetworkSharing": {
            "rpcs": {
                "ReadyForWifiConnection": {
                    "encryption_required": false,
                    "hmi_levels": [
                        "BACKGROUND",
                        "FULL",
                        "LIMITED",
                        "NONE"
                    ]
                },
                "JoinMobileNetwork": {
                    "encryption_required": true,
                    "hmi_levels": [
                        "BACKGROUND",
                        "FULL",
                        "LIMITED",
                        "NONE"
                    ]
                },
                "JoinVehicleNetwork": {
                    "encryption_required": true,
                    "hmi_levels": [
                        "BACKGROUND",
                        "FULL",
                        "LIMITED",
                        "NONE"
                    ]
                }
            }
        }
    }
}
```

## Potential Downsides

SDL is not able to check that 2 different transport belongs to the same device.
The device connected by 2 different types of transport will be considered by SDL as 2 different devices.

## Alternative solutions 

1. Use `OnSystemRequest` with subtype `WIFI_READY_TO_CONNECT`  instead of `ReadyForWifiConnection`

2. Add DeviceID parameter to RAI request. So sdl_proxy should be responsible for providing a unique Device identifier.

3. Add `MobileNetworkCapabilitiesUpdate` RPC from mobile to Vehicle to inform Vehicle that mobile network capabilities updated. For example, the user manually created a hotspot on mobile, and the application is not able to join the Wifi network anymore. 

4. Start secondary transport right after registration, but not on app Activation. It prevents sending redundant `JoinVehicleNetwork`/`ReadyForWifiConnection` to the application. 

5. Send WiFI SSID in `RegisterAppInterface`.
It is possible for the device to be connected to WiFi before any application is registered (for example, manual connection). In this case it will be useful for IVI to be aware of this connection. So, as an alternative, it is proposed to send SSID of currently connected WiFi network within `RegisterAppInterface` request. However, this approach introduces a number of issues:
* SSID is not unique enough identifier
* the access point could be configured in a way not to share SSID. In this case, it's sharing from mobile device could become a security issue
